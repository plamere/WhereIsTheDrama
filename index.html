<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link type="text/css" href="styles.css" rel="stylesheet" />
    <link href="https://sp-bootstrap.global.ssl.fastly.net/7.4.1/sp-bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="images/favicon.png">
    <title>Where is the Drama?</title>
    <!-- Custom styles for this template -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
  <body >
    <div id="navbar" class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="navbar-inner">
        <div class="navbar-header">
          <a class="navbar-brand" href="index.html">
            <span class="navbar-logo">Spotify</span>
            <span class="navbar-title">Where is the Drama?</span>
          </a>
        </div>
        <div class="navbar-collapse collapse">
          <div> 
            <img src="images/spotify.png" class='clickable pull-right' id="cover-art">
          </div>
        </div><!--/.navbar-collapse -->

    </div> 
    </div>


    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div id='top' class="jumbotron jumbotron-inverse jumbotron-hero sp-jumbotron-custom-inverse">
      <div id="intro" class="container-fluid" id="jumbo-dialog">
        <h1 id='ttitle' > Where is the Drama?</h1>
        <div id="search-form" class="row">
            <p id='ttext'>
                Play a song on Spotify and we will show you where the <b class="label
                label-primary">DRAMA</b> is.
            </p>
            <br>
            <a class="btn btn-primary btn-lg go" id='login-button' role="button">Login with Spotify to get started</a>
        </div>
        <div id='info' class="h1 text-center"></div>
      </div>
    </div>
    <div class="ncontainer">
      <div id="no-song" class="work" style="display:none"> 
        <h2> Play a song on Spotify to see all the drama. </h2>
        Or try one of these examples:

        <ul id="song-list">
            <li> <a href="?trid=spotify:track:3nm8DwebzyBkQB1vb9mKsG"> Pines of Rome - Ottorino Respighi</a> </li>
            <li> <a href="?trid=spotify:track:2vwlzO0Qp8kfEtzTsCXfyE"> Wrecking Ball - Miley Cyrus </a> </li>
            <li> <a href="?trid=spotify:track:0aym2LBJBk9DAYuHHutrIl"> Hey Jude - The Beatles</a> </li>
            <li> <a href="?trid=spotify:track:3PYdxIDuBIuJSDGwfptFx4"> My Immortal- Evanescence</a> </li>
            <li> <a href="?trid=spotify:track:2G2zbUj2nuznhWAl3CCZcK"> Alive - Ravenscry</a> </li>
            <li> <a href="?trid=spotify:track:1rxD34LAtkafrMUHqHIV76"> Bring it on Home - Led Zeppelin</a> </li>
            <li> <a href="?trid=spotify:track:2O7JpRcsiuSXUbA7rCI855"> The Promise - Within Temptation</a> </li>
            <li> <a href="?trid=spotify:track:2s1sdSqGcKxpPr5lCl7jA">  Chandelier- Sia </a> </li>
            <li> <a href="?trid=spotify:track:6oWacAPUt8LMXqRkEk2MNg"> 1812 Overture - Tchaikovsky </a> </li>
            <li> <a href="?trid=spotify:track:1t9us2hggVqmnyWz7uG54y"> Unison - Bj√∂rk</a> </li>
            <li> <a href="?trid=spotify:track:7tFiyTwD0nx5a1eklYtX2J"> Bohemian Rhapsody - Queen</a> </li>
            <li> <a href="?trid=spotify:track:5zhuWncJsBKrQ1HhmAKNAg"> Hall of the Mountain King- Edvard Grieg</a> </li>
            <li> <a href="?trid=spotify:track:52Fw0bPlDegUpoETTxtIgf"> Taijin Kyofusho- Evpatoria Report </a> </li>
            <li> <a href="?trid=spotify:track:6mkdHi4RAWqGpkB6pPLfPK"> A Poor Man's Memory - Explosions in the Sky</a> </li>
            <li> <a href="?trid=spotify:track:2TjdnqlpwOjhijHCwHCP2d"> Great Gig in the SKy - Pink Floyd</a> </li>
            <li> <a href="?trid=spotify:track:1rOlTL4pKQ9Y1fURua4AJR"> My Body is A Cage - Arcade Fire </a> </li>
            <li> <a href="?trid=spotify:track:4YXLgkSe0ehsnYf00WPTeW"> Organ Symphony - Camille Saint-Saens</a> </li>
            <li> <a href="?trid=spotify:track:0kc4Bh5XrexsUbQw8kojrp"> Ghost Love Score - Nightwish</a> </li>
            <li> <a href="?trid=spotify:track:0ILR5GMSzBRp2LrI8GX1Si"> I'll follow you- Shinedown</a> </li>
        </ul>

        Or anything in this playlist <a href="spotify:user:ruhin94:playlist:0bG1EMQkukEeO7vvcQQQYU"> Holy Shit - An Incredibly Epic Playlist | Music Scores and Soundtracks </a>
      </div>

      <div id="work" class="work" style="display:none"> 
        <a id="go-drama" title="skip to the drama!!" class="xbtn btn-danger btn-xs pull-left"><span class="glyphicon glyphicon-fire"></span></a>
        <a id="btn-pause" style="display:none" title="pause" class="xbtn btn-primary btn-xs pull-left"><span class="glyphicon glyphicon-pause"></span></a>
        <a id="btn-play" title="play" class="xbtn btn-primary btn-xs pull-left"><span class="glyphicon glyphicon-play"></span></a>
        <button id="btn-gallery" title="gallery" class="xbtn btn-primary btn-xs pull-left">Gallery</button>
        <!--
        <a id="btn-next" title="next" class="xbtn btn-primary btn-xs pull-left"><span class="glyphicon glyphicon-step-forward"></span></a>
        -->
        <img id="spinner" class="pull-left" src="images/ajaxSpinner.gif" width="32px">
        <span id='loading' class="pull-left"> loading </span>
        <span class="pull-right" id='tweet-span'> 
            <a href="https://twitter.com/share" data-size="large" id='tweet' class="twitter-share-button" data-lang="en" data-count='none'>Tweet</a>
            <script>!function(d,s,id){var
            js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
        </span>
        <div>
            <br>
        </div>
       <div id="viz-contents"> 
          <div style="width:100%; height:700px;" id='visualization'> </div>
       </div>
      </div>
      <div id='the-tweet' class="row">
        <div class='text-center'>
        </div>
      </div>
    </div> 
      </div>
    </div>

    <div id="footer">
      <div class="container text-center">
            <p class="text-muted">
                Created by <a href="http://twitter.com/plamere">@plamere</a>
                at <a href="http://musichackday.de/"> Music Hack Day Berlin</a>.
                More info at <a href="https://musicmachinery.com/2014/09/08/more-on-wheres-the-drama/">Music
                Machinery</a>.
            <br>
                Powered by <a href="http://spotify.com">Spotify</a> and
                <a href="http://www.highcharts.com/">Highcharts</a>.
            <br>
                Image by <a href="https://www.flickr.com/photos/bigfez/243030084/">Tom Olliver</a>
            </p>

      </div>
    </div>
    <script src="lib/jquery-1.11.1.min.js"></script>
    <script src="lib/bootstrap.min.js"></script>
    <script src="lib/underscore-min.js"></script>
    <script src="lib/highcharts.js"></script>
    <script src="config.js"></script>

<script>
"use strict";

/*
    warning: janky code ahead. Lots of crazy stuff happens at 4AM during a music
    hack day. 
*/

var accessToken = null;
var curTrack = null;
var curPercent = 0;
var theChart = null;
var thePeaks = null;
var pointsPerSong = 200;
var isAutoUpdate = false;

function shrinkHeader() {
    $("#top").hide(400);
}

function isLocalHost() {
    return window.location.host.indexOf('localhost') >= 0;
}

function authorizeUser() {
    var scopes = 'user-top-read user-read-recently-played user-read-currently-playing user-read-playback-state user-modify-playback-state';
    var url = 'https://accounts.spotify.com/authorize?client_id=' + SPOTIFY_CLIENT_ID +
        '&response_type=token' +
        '&show_dialog=false' +
        '&scope=' + encodeURIComponent(scopes) +
        '&redirect_uri=' + encodeURIComponent(SPOTIFY_REDIRECT_URI);
    document.location = url;
}

function parseHash() {
    var hash = location.hash.replace(/#/g, '');
    var all = hash.split('&');
    var args = {};
    _.each(all, function(keyvalue) {
        var kv = keyvalue.split('=');
        var key = kv[0];
        var val = kv[1];
        args[key] = val;
    });
    return args;
}

function parseArgs() {
    var params = {};
    var q = document.URL.split('?')[1];
    if(q != undefined){
        q = q.split('&');
        for(var i = 0; i < q.length; i++){
            var pv = q[i].split('=');
            var p = pv[0];
            var v = pv[1];
            params[p] = urldecode(v);
        }
    }
    return params;
}


var timer = null;

function pause() {
    showPlay(btn);
    window.open('spotify:track:07aUR8QqhFOObXHRYLZ74n', '_parent');
    if (timer) {
        clearInterval(timer);
        timer = null;
    }
}

function p2d(i) {
    var res =  i / pointsPerSong * curTrack.duration;
    return res;
}

function findPeaks(vec) {
    var all_top = [];
    var maxDramaTime = 30;
    var max = 0;
    var maxDelta = 0;
    var start = 10; 

    if (curTrack.duration > 300) {
        maxDramaTime = 60;
    }

    if (curTrack.duration > 600) {
        maxDramaTime = 90;
    }

    for (var i = 0; i < vec.length - 1; i++) {
        var sv = vec[i];
        var top = 0;
        var tidx = 0;
        if (i >= start && sv > max) {
            max = sv;
        }
        if (i >= start) {
            for (var j = i + 1; j < vec.length; j++) {
                if (p2d(j - i) > maxDramaTime) {
                    break;
                }
                var ev = vec[j];
                var dv = ev - sv;
                if (dv > top) {
                    top = dv;
                    tidx = j;
                    if (dv > maxDelta) {
                        maxDelta = dv;
                    }
                }
            }
            all_top.push([top, tidx]);
        } else {
            all_top.push([0, i + 1]);
        }
    }


    var out = [];
    _.each(all_top, function(v, i) {
        var delta = v[0];
        var peak = vec[v[1]];
        if ((out.length == 0 && delta > 0) || (peak >= .8 * max && delta >= .5 * maxDelta)) {
            var score = v[0] * peak;
            // out.push( [v[0], i, v[1]])
            out.push( [score, i, v[1]])
        }
    });

    out.sort(function(a,b) {
        return a[0] - b[0];
    });
    out.reverse()

    var out2 = [];

    for (var i = 0; i < out.length; i++) {
        var v = out[i][0];
        var idx = out[i][1];
        var ok = true;

        for (var j = 0; j < out2.length; j++) {
            var idx2 = out2[j][1];
            var dist = Math.abs(idx - idx2);
            if (p2d(dist) < maxDramaTime) {
                ok = false;
            }
        }
        if (ok && out[i][0] > 0) {
            out2.push( out[i] )
        }
    }
    return out2;
}

function playNext() {
    var url = 'https://api.spotify.com/v1/me/player/next';
    callSpotify("POST", url, null, function(status, data) { refreshNowPlaying() });
}

function seek(position_ms) {
    var url = 'https://api.spotify.com/v1/me/player/seek?position_ms=' + position_ms;
    callSpotify("PUT", url, null, function(status, data) { });
}

function pause() {
    var url = 'https://api.spotify.com/v1/me/player/pause';
    callSpotify("PUT", url, null, function(status, data) { refreshNowPlaying(); });
}

function play() {
    var url = 'https://api.spotify.com/v1/me/player/play';
    callSpotify("PUT", url, null, function(status, data) { refreshNowPlaying(); });
}

function playTrack(uri, callback) {
    var url = 'https://api.spotify.com/v1/me/player/play';
    callSpotify("PUT", url, { uris: [uri]} , function(status, data) { if (callback) callback(); });
}


function percentToTime(track, percent) {
    return percent / pointsPerSong * track.duration;
}


function percentToLabel(track, percent) {
    var time = percentToTime(track, percent);
    var mins = Math.floor(time / 60);
    var secs = Math.round(time - mins * 60);
    var ssecs = secs.toString()
    if (ssecs.length < 2) {
        ssecs = '0' + ssecs;
    }
    var label =  mins + ":" + ssecs;
    return label
}

function uri_to_id(uri) {
    var fields = uri.split(':');
    if (fields.length == 3) {
        return fields[2];
    } else {
        return uri;
    }
}

function loading(track) {
    if (track) {
        $("#spinner").show();
        $("#loading").text("finding the drama in " + track.name + " by " + track.artists[0].name);
        $("#loading").show();
    } else {
        $("#spinner").hide();
        $("#loading").hide();
    }
}

function fetchAnalysis(track) {
    loading(track);
    var url = 'https://api.spotify.com/v1/audio-analysis/' + uri_to_id(track.uri);
    callSpotify("GET", url, null, function(status, analysis) {
        if (track.uri == curTrack.uri) {
            loading(null);
            $("#work").show();
            $("#no-song").hide();
            track.analysis = analysis;
            var segs = track.analysis.segments;
            var last = segs[segs.length - 1];
            track.duration = last.start + last.duration;
            plotTrack(track);
            tweetSetup();
            curTrack.lastSegment = 0;
        }
    });
}


function interp(t, st, et, sv, ev) {
    var frac = (t - st) / (et - st);
    return (ev - sv) * frac + sv;
}

function oldWindowedAverage(vec, winsize) {
    var out = [];
    for (var i = 0; i < vec.length;  i += winsize * 2) {
        var sum = 0;
        var count = 0;
        for (var j = -winsize; j <= winsize; j++) {
            var idx = i + j;
            if (idx >= 0 && idx < vec.length) {
                sum += vec[idx];
                count += 1;
            }
        }
        out.push(sum / count);
    }
    return out;
}

function windowedAverage(vec, winsize) {
    var out = [];
    for (var i = 0; i < vec.length;  i += winsize * 2) {
        var sum = 0;
        var count = 0;
        var window = [];
        for (var j = -winsize; j <= winsize; j++) {
            var idx = i + j;
            if (idx >= 0 && idx < vec.length) {
                window.push(vec[idx]);
            }
        }
        window.sort();
        out.push(window[Math.round(window.length / 2)])
    }
    return out;
}

function getFilteredData(track) {
    var ydata = [];
    var segs = track.analysis.segments;
    var first = segs[0];
    var cseg = first;
    var last = segs[segs.length - 1];

    _.each(segs, function(seg, i) {
        seg.which = i;
        seg.end = seg.start + seg.duration;
        if  (i  < segs.length - 1) {
            seg.next = segs[i + 1]
        } else {
            seg.next = null;
        }
    });


    var out = [];
    var windowSize = 20;
    var nPoints = pointsPerSong * windowSize * 2;
    for (var permille = 0; permille < nPoints; permille += 1) {
        var secs = permille / nPoints * track.duration;
        var val = -60;
        while (cseg && secs > cseg.end) {
            cseg = cseg.next;
        }
        if (secs >= cseg.start && secs < cseg.loudness_max_time) {
            val = interp(secs, cseg.start, cseg.loudness_max_time, cseg.loudness_start, cseg.loudness_max);
        } else {
            var loudness_end = cseg.next ? cseg.next.loudness_start : -60;
            val = interp(secs, cseg.loudness_max_time, cseg.end, cseg.loudness_max, loudness_end);
        }
        out.push(loud(val));
    }

    var avg = windowedAverage(out, windowSize)
    return avg;
}

function loud(v) {
    var val =  (v + 60)  / 60.; 
    return val * val * val;
}


function plotTrack(track) {
    $("#work").show();
    var chartDiv = $("#visualization");
    curPercent = 0;
    var y2data = getFilteredData(track);
    var xlabels = [];
    var peaks = findPeaks(y2data);
    thePeaks = peaks;

    _.each(y2data, function(v,i) {
        xlabels.push(percentToLabel(track, i));
    });

    var y3data = [];

    _.each(y2data, function(y) {
        y3data.push(null);
    });

    _.each(peaks, function(peak, i) {
        if (i != 0) {
            return;
        }
        var start = peak[1];
        var end = peak[2];
        if (end + 1 < y2data.length) {
            end += 1;
        }
        var factor = .99;
        for (var i = start; i <= end; i++) {
            y3data[i] = y2data[i] * factor;
        }
    });

    $(function () { 
        chartDiv.highcharts({
            chart: {
                type:'areaspline',
            },

            plotOptions: {
                series: {
                    marker: {
                        radius:0.1,
                        states: {
                            hover: {
                                radius:5
                            },
                            select: {
                                radius:5
                            }
                        }
                    },
                    point: {
                        events: {
                            click: function(e) {
                                if (curTrack) {
                                    seek((Math.round(this.x / pointsPerSong * curTrack.duration) * 1000));
                                }
                            },
                        }
                    }
                },
                area: {
                    events: {
                        click: function(e) {
                        }
                    },
                    fillColor: {
                        linearGradient: {
                            x1: 0,
                            y1: 0,
                            x2: 0,
                            y2: 1
                        },
                        stops: [
                            [0, Highcharts.getOptions().colors[0]],
                            [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                        ]
                    },

                    marker: {
                        radius:0.1,
                        states: {
                            hover: {
                                radius:5
                            },
                            select: {
                                radius:5
                            }
                        }
                    },
                    lineWidth: 1,
                    states: {
                        hover: {
                            lineWidth: 1
                        }
                    },
                    threshold: null
                },
            },

            title: {
                text: track.name + ' - ' + track.artists[0].name
            },

            tooltip: {
                formatter: function () {
                    var drama = Math.round(this.y * 100) / 100;
                    return 'The drama at <b>' + this.x + '</b> is <b>' + drama + '</b>';
                 }
            },

            xAxis: {
                categories: xlabels,
                labels: {
                    step:8,
                    staggerLines:1
                },
                crosshair:true,
                title: {
                    text: 'time'
                }
            },

            yAxis: {
                max:1,
                min:0,
                title: {
                    text: 'The Drama'
                }
            },


            series: [
                {
                    name:'Loudness',
                    data:y2data
                },
                {
                    name:'Peak Drama',
                    data:y3data
                },
            ]
        });
        theChart = chartDiv.highcharts();
    });
}


function error(msg) {
    info(msg);
}

function info(msg) {
    var info = $("#info");
    if (msg.length == 0) {
        info.hide();
    } else {
        $("#info").text(msg);
        info.show();
    }
}


function showPause(btn) {
    btn.find("i").removeClass('glyphicon-play');
    btn.find("i").addClass('glyphicon-pause');
    btn.find("i").text(' Stop the drama');
}

function showPlay(btn) {
    btn.find("i").removeClass('glyphicon-pause');
    btn.find("i").addClass('glyphicon-play');
    btn.find("i").text(' Play the drama');
}

function urldecode(str) {
   return decodeURIComponent((str+'').replace(/\+/g, '%20'));
}

function processParams() {
    var params = {};
    var q = document.URL.split('?')[1];
    if(q != undefined){
        q = q.split('&');
        for(var i = 0; i < q.length; i++){
            var pv = q[i].split('=');
            var p = pv[0];
            var v = pv[1];
            params[p] = urldecode(v);
        }
    }
}

function loadTrack(trid) {
    console.log('loadTrack', trid);
    var url = 'https://api.spotify.com/v1/tracks/' + uri_to_id(trid);
    callSpotify("GET", url, null, function(status, track) {
        if (track == null) {
            $("#work").hide();
            $("#no-song").show();
            return;
        }

        $("#work").show();
        $("#no-song").hide();

        setNewTrack(track);
    });
}

function now() {
    var d = new Date();
    return d.getTime()
}

function callSpotify(type, url, json, callback) {
    var payload = {
        type: type,
        headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
        },
        success: function(r) {
            callback(true, r);
        },
        error: function(r) {
            // 2XX status codes are good, but some have no
            // response data which triggers the error handler
            // convert it to goodness.
            if (r.status >= 200 && r.status < 300) {
                callback(true, r);
            } else {
                callback(false, r);
            }
        }
    };

    if (json != null) {
        payload.data = JSON.stringify(json);
        payload.dataType = 'json';
    }

    $.ajax(url, payload);
}


function fetchNowPlaying(callback) {
    var url = 'https://api.spotify.com/v1/me/player/currently-playing';
    callSpotify("GET", url, null, callback);
}

function updatePlotProgress(timestamp) {
    var percent = Math.round(pointsPerSong * timestamp / curTrack.duration);
    if (curTrack && theChart && theChart.series && theChart.series.length > 0 && theChart.series[0].data.length > percent) {
        theChart.series[0].data[percent].select(true);
    }
}

var lastPlayState = false;


function setNewTrack(track) {
    if (curTrack == null || track.uri != curTrack.uri) {
        if (track.album && track.album.images.length > 0) {
            $("#cover-art").attr('src', track.album.images[0].url);
        }
        curTrack = track;
        setURL();
        fetchAnalysis(curTrack);
        return true;
    } else {
        return false;
    }
}



function refreshNowPlaying() {
    fetchNowPlaying(function(status, data) {
        if (data == null) {
            $("#work").hide();
            $("#no-song").show();
            return;
        }

        if (data.is_playing != lastPlayState) {
            lastPlayState = data.is_playing;
            if (lastPlayState) {
                $("#btn-play").hide();
                $("#btn-pause").show();
            } else {
                $("#btn-play").show();
                $("#btn-pause").hide();
            }
        }

        if (!setNewTrack(data.item)) {
            updatePlotProgress(Math.round(data.progress_ms / 1000));
        }
    });
}

function autoRefreshNowPlaying() {
    isAutoUpdate = true;
    refreshNowPlaying();
    setTimeout(autoRefreshNowPlaying, 200);
}

function isFirstTimeVisitor() {
    var loggedIn = localStorage.getItem("hasLoggedIn");
    return loggedIn == null;
}

function startPlayingTrackAt(uri, seekPos) {
    playTrack(uri, function() {
        whenTrackIsPlayingSeekTo(uri, seekPos);
    });
}


function whenTrackIsPlayingSeekTo(uri, seekPos) {
    fetchNowPlaying(function(status, data) {
        console.log('wtips', uri, data.item.uri, seekPos);
        var track = data.item;
        if (track.uri == uri) {
            if (seekPos != 0) {
                seek(seekPos);
            }
            autoRefreshNowPlaying();
        } else {
            setTimeout(function() { whenTrackIsPlayingSeekTo(uri, seekPos); }, 200);
        }
    });
}

$(document).ready(
    function() {

        if (isLocalHost()) {
            SPOTIFY_REDIRECT_URI = LOCAL_SPOTIFY_REDIRECT_URI;
        }
        var hash = parseHash();
        var args = parseArgs();
        window.location.hash = "";

        if ('trid' in args) {
            var trackUri = args['trid'];
            localStorage.setItem("trid", trackUri);
        } 

        $(".work").hide();
        if ('error' in hash) {
            error("Sorry, I can't read your play history Spotify without authorization");
            $("#login-button").show();
            $("#login-button").on('click', function() {
                authorizeUser();
            });
        } else if ('access_token' in hash) {
            accessToken = hash['access_token'];
            localStorage.setItem("hasLoggedIn", "true");
            var trid = localStorage.getItem("trid"); 
            shrinkHeader();
            if (trid) {
               console.log('trid', trid);
               localStorage.removeItem("trid"); 
               loadTrack(trid);
            } else {
                $("#work").show();
                $("#no-song").hide();
                autoRefreshNowPlaying();
            }
        } else {
            $("#login-button").on('click', function() {
                authorizeUser();
            });
            if (localStorage.getItem('hasLoggedIn') == "true") {
                authorizeUser();
            }
        }

        $("#go-drama").on('click', function() {
            if (thePeaks) {
                var percent = thePeaks[0][1];
                if (!isAutoUpdate) {
                    startPlayingTrackAt(curTrack.uri, (Math.round(percent / pointsPerSong * curTrack.duration) * 1000));
                } else {
                    seek((Math.round(percent / pointsPerSong * curTrack.duration) * 1000));
                    if (!lastPlayState) {
                        play();
                    }
                }
            } 
        });

        $("#btn-play").on("click", function() {
            if (isAutoUpdate) {
                play();
            } else {
                if (curTrack) {
                    startPlayingTrackAt(curTrack.uri, 0);
                }
            }
            $("#btn-play").hide();
            $("#btn-pause").show();
        });

        $("#btn-gallery").on("click", function() {
            $("#no-song").show();
            $("#work").hide();
        });

        $("#btn-pause").on("click", function() {
            pause();
            $("#btn-play").show();
            $("#btn-pause").hide();
        });

        $("#btn-next").on("click", function() {
            playNext();
        });

    }
);


function setURL() {
    if (curTrack) {
        var p = '?trid=' + curTrack.uri;
        history.replaceState({}, document.title, p);
    }
    tweetSetup();
}

function tweetSetup() {
    $(".twitter-share-button").remove();
    var tweet = $('<a>')
        .attr('href', "https://twitter.com/share")
        .attr('id', "tweet")
        .attr('class', "twitter-share-button")
        .attr('data-lang', "en")
        .attr('data-size', "large")
        .attr('data-count', "none")
        .text('Tweet');

    $("#tweet-span").prepend(tweet);

    var msg = 'Where is the Drama?';

    if (curTrack && curTrack.name) {
        msg = 'I found the drama in ' +  curTrack.name + ' by ' + curTrack.artists[0].name + ' with #wheresthedrama'  
    }  

    tweet.attr('data-text', msg);
    tweet.attr('data-url', document.URL);

    // twitter can be troublesome. If it is not there, don't bother loading it
    if ('twttr' in window && twttr.widgets) {
        twttr.widgets.load();
    }
}


</script>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3675615-11']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type =
'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>
